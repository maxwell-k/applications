- import_tasks: node-distribution.yaml
- name: Create a directory
  become: yes
  file:
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    path: /opt/{{ npm_name }}
- name: Copy in package.json and package-lock.json
  become: no
  copy:
    src: "{{ item }}"
    dest: /opt/{{ npm_name }}/{{ item }}
  loop: [package-lock.json, package.json]
- name:
    npm ci, should switch back to the npm module once Ansible 2.8 is available
    on all distributions
  become: no
  command: npm ci
  args:
    chdir: /opt/{{ npm_name }}
    creates: /opt/{{ npm_name }}/node_modules
- name: Install link to binaries
  become: yes
  file:
    state: link
    src: /opt/{{ npm_name }}/node_modules/.bin/{{ item }}
    dest: /usr/local/bin/{{ item }}
  loop: "{{ npm_binaries | default([npm_name]) }}"
- name: Run the installed binaries
  command: "{{ item }} --version"
  changed_when: no
  loop: "{{ npm_versions|default(npm_binaries|default([npm_name])) }}"
  register: npm_version_check
- name: Show the installed version
  debug:
    msg: |
      {% set output = {} %}
      {% for i in npm_version_check.results %}
      {%   set _ignore = output.update({i.cmd | join(' '): i.stdout}) %}
      {% endfor %}
      {{ output }}
  when: not npm_version_check is skipped
#
# Copyright 2018, 2019 Keith Maxwell
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy of
# the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.
