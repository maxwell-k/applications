- name: Create a directory
  file:
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    path: /opt/{{ role_name }}
- name: Copy in package.json
  become: no
  copy:
    src: package.json
    dest: /opt/{{ role_name }}/package.json
- name: Install with NPM
  become: no
  npm: { path: "/opt/{{ role_name }}" }
- name: Install link to binaries
  file:
    state: link
    src: /opt/{{ role_name }}/node_modules/.bin/{{ item }}
    dest: /usr/local/bin/{{ item }}
  loop: "{{ lookup('vars', role_name + '_binaries', default=[role_name]) }}"
- name: Run the installed binaries
  command: "{{ item }} --version"
  changed_when: no
  loop: |
    {{
      lookup('vars', role_name + '_versions', default=[
        lookup('vars', role_name + '_binaries', default=role_name)
      ])
    }}
  register: javascript_version
- name: Show the installed version
  tags: [print_action]
  debug:
    msg: |
      {{
        dict(
          javascript_version
          | json_query('results[].cmd')
          | map('join', ' ')
          | zip( javascript_version | json_query('results[].stdout') )
        )
      }}
  when: not javascript_version is skipped
# Copyright 2018 Keith Maxwell
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy of
# the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.
